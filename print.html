<!DOCTYPE HTML>
<html lang="ja" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DynamoDB ハンズオン</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="workshop materials">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">AWS DynamoDB ハンズオン</a></li><li class="chapter-item expanded "><a href="prerequisite_knowledges.html"><strong aria-hidden="true">1.</strong> 抑えておくべき概念</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="prerequisite_tables.html"><strong aria-hidden="true">1.1.</strong> テーブル・項目・属性</a></li><li class="chapter-item expanded "><a href="prerequisite_keys.html"><strong aria-hidden="true">1.2.</strong> キー</a></li><li class="chapter-item expanded "><a href="prerequisite_capacity_unit.html"><strong aria-hidden="true">1.3.</strong> キャパシティユニット</a></li><li class="chapter-item expanded "><a href="prerequisite_index.html"><strong aria-hidden="true">1.4.</strong> インデックス</a></li></ol></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">2.</strong> テーブル設計における注意点</a></li><li class="chapter-item expanded "><a href="operations.html"><strong aria-hidden="true">3.</strong> オペレーションの種類</a></li><li class="chapter-item expanded "><a href="hands_on.html"><strong aria-hidden="true">4.</strong> ハンズオン</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="hands_on_list_tables.html"><strong aria-hidden="true">4.1.</strong> テーブル一覧を取得</a></li><li class="chapter-item expanded "><a href="hands_on_describe_tables.html"><strong aria-hidden="true">4.2.</strong> テーブル詳細を取得</a></li><li class="chapter-item expanded "><a href="hands_on_scan.html"><strong aria-hidden="true">4.3.</strong> Scanを実行</a></li><li class="chapter-item expanded "><a href="hands_on_query.html"><strong aria-hidden="true">4.4.</strong> Queryを実行</a></li><li class="chapter-item expanded "><a href="hands_on_add_gsi.html"><strong aria-hidden="true">4.5.</strong> GSIを追加</a></li><li class="chapter-item expanded "><a href="hands_on_gsi_query.html"><strong aria-hidden="true">4.6.</strong> GSIを使用してQueryを実行</a></li><li class="chapter-item expanded "><a href="hands_on_scan_filter_caution.html"><strong aria-hidden="true">4.7.</strong> Scan, Filter の注意点</a></li></ol></li><li class="chapter-item expanded "><a href="conclusion.html"><strong aria-hidden="true">5.</strong> おわりに</a></li><li class="chapter-item expanded "><a href="references.html"><strong aria-hidden="true">6.</strong> 参考</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">DynamoDB ハンズオン</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="aws-dynamodb-ハンズオン"><a class="header" href="#aws-dynamodb-ハンズオン">AWS DynamoDB ハンズオン</a></h1>
<h2 id="img-srchttpsrescloudinarycomddaz9etkximageuploadv1630071926202108untitled_pm3wuzpng-width40px-dynamodbとは"><a class="header" href="#img-srchttpsrescloudinarycomddaz9etkximageuploadv1630071926202108untitled_pm3wuzpng-width40px-dynamodbとは"><img src="https://res.cloudinary.com/ddaz9etkx/image/upload/v1630071926/202108/Untitled_pm3wuz.png" width="40px"> DynamoDBとは？</a></h2>
<p>AWSマネージドの <strong>NoSQL</strong> データベースです。</p>
<h3 id="nosql-not-only-sql"><a class="header" href="#nosql-not-only-sql">NoSQL (Not Only SQL)</a></h3>
<p>RDBMS以外のDBMSを指します。</p>
<p>扱うデータによっては非常に高速になります。</p>
<p>NoSQLの中にもいろいろな種類があります。</p>
<ul>
<li>Key-Value store
<ul>
<li>Keyに対してValueを格納する構造</li>
</ul>
</li>
<li>Document store
<ul>
<li>自由なデータ構造で「ドキュメント」として格納する</li>
<li>XML, YAML, JSON</li>
<li>key-value store に含まれる</li>
</ul>
</li>
<li>Graph
<ul>
<li>グラフ構造</li>
</ul>
</li>
<li>Column-oriented store （列指向）
<ul>
<li>列方向にデータを扱う</li>
</ul>
</li>
<li>Object database
<ul>
<li>オブジェクト指向的にデータを扱う</li>
</ul>
</li>
</ul>
<p><strong>DynamoDB は Document store / Key-Value store</strong> に該当します。</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="抑えておくべき概念"><a class="header" href="#抑えておくべき概念">抑えておくべき概念</a></h1>
<p>DynamoDB を使用する上で必要になる事項について述べます。</p>
<ul>
<li>テーブル・項目・属性</li>
<li>キー</li>
<li>インデックス</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="テーブル項目属性"><a class="header" href="#テーブル項目属性">テーブル・項目・属性</a></h1>
<p>呼称は異なりますが、
RDBにおけるテーブルやカラムなどはDynamoDBでも共通の概念です。</p>
<ul>
<li>テーブル(Tables)
<ul>
<li>データのコレクション</li>
<li>RDBのテーブルと同様</li>
</ul>
</li>
<li>項目(Items)
<ul>
<li>一意に識別可能な属性のグループ</li>
<li>RDBの行・レコードに対応</li>
</ul>
</li>
<li>属性(Attributes)
<ul>
<li>データ要素</li>
<li>RDBの列・フィールドに対応</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="キー"><a class="header" href="#キー">キー</a></h1>
<p>DynamoDB には以下二種類のキーが存在します。</p>
<ul>
<li>パーティションキー
<ul>
<li>ハッシュキーとも</li>
<li>必ず必要</li>
<li>ハッシュ関数への入力として使用される</li>
<li>物理的に<strong>項目が保存されるパーティション</strong>が決まる</li>
</ul>
</li>
<li>ソートキー
<ul>
<li>レンジキーとも</li>
<li>指定しなくても良い</li>
<li>パーティションキーと合わせて複合主キーとなる必要がある</li>
<li>同じパーティションキーの項目はソートキーでソートされて保存される</li>
</ul>
</li>
</ul>
<p><strong>パーティションキーとソートキーで一意</strong>になる必要があります。</p>
<p>→ RDBのように3列以上での複合主キーは設定できません。</p>
<p>よって、主キー（プライマリキー）を設定するためには</p>
<ul>
<li>パーティションキーのみ指定して主キーとする</li>
<li>パーティションキーとソートキーを指定して主キーとする</li>
</ul>
<p>のどちらかになります。</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="キャパシティユニット"><a class="header" href="#キャパシティユニット">キャパシティユニット</a></h1>
<p>DynamoDB には<strong>キャパシティユニット</strong>という概念があり、
読み込み・書き込みリクエストに対してそれぞれ RCU(Read Capacity Unit), WCU(Write Capacity Unit) という容量が消費されていきます。</p>
<p>消費したキャパシティユニットに応じた料金が請求されます。</p>
<p><a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/ProvisionedThroughput.html">DynamoDB のプロビジョンされた容量テーブルの設定の管理</a></p>
<ul>
<li>1 RCU
<ul>
<li>最大サイズ <strong>4 KB</strong> の項目について、 1 秒あたり 2 回の結果整合性のある読み込み</li>
<li>強力な整合性のある読み込みでは 2 倍消費</li>
</ul>
</li>
<li>1 WCU
<ul>
<li>最大サイズが <strong>1 KB</strong> の項目について、1 秒あたり 1 回の書き込み</li>
<li>トランザクション書き込みリクエストでは 2 倍消費</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="インデックス"><a class="header" href="#インデックス">インデックス</a></h1>
<p>重要な概念です。</p>
<p>インデックスを使用することで効率的にデータを取得することができます。</p>
<h2 id="gsiグローバルセカンダリインデックス"><a class="header" href="#gsiグローバルセカンダリインデックス">GSI(グローバルセカンダリインデックス)</a></h2>
<ul>
<li>インデックスのプライマリキーを任意に指定可能</li>
<li>一意にならなくてもよい</li>
<li><strong>キャパシティユニットを消費</strong>する</li>
<li>テーブル作成後に追加可能</li>
</ul>
<h2 id="lsiローカルセカンダリインデックス"><a class="header" href="#lsiローカルセカンダリインデックス">LSI(ローカルセカンダリインデックス)</a></h2>
<ul>
<li>テーブルのパーティションキーを使用</li>
<li>ソートキーは任意に指定可能</li>
<li><strong>テーブル作成時</strong>に指定する（テーブル作成後はLSIを追加できない）</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="テーブル設計における注意点"><a class="header" href="#テーブル設計における注意点">テーブル設計における注意点</a></h1>
<h2 id="正規化しなくてよい"><a class="header" href="#正規化しなくてよい">正規化しなくてよい</a></h2>
<p>できるだけ少ないテーブル数を維持するのがベストプラクティスとして挙げられています。</p>
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/best-practices.html">DynamoDB を使用した設計とアーキテクチャの設計に関するベストプラクティス - Amazon DynamoDB</a></li>
</ul>
<blockquote>
<p>DynamoDB では、最も一般的で重要なクエリをできるだけ速く、安価にするために、具体的にスキーマを設計します。データ構造は、ビジネスユースケースの特定の要件に合わせて調整されています。</p>
</blockquote>
<h3 id="join-できない"><a class="header" href="#join-できない">JOIN できない</a></h3>
<p>RDB のような JOIN の概念はありません。</p>
<p>関連するデータはまとめて格納しておくのが良い手法とされています。</p>
<h2 id="結果整合性"><a class="header" href="#結果整合性">結果整合性</a></h2>
<p>読み込み時に書き込み要求が反映されていない結果が返されることがあります。</p>
<p>※だいたい1秒以内には反映されるようです。</p>
<p><a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/HowItWorks.ReadConsistency.html">読み込み整合性</a></p>
<p>デフォルトでは<strong>結果整合性のある読み込み</strong>が使用されますが、必要に応じて<strong>強力な整合性のある読み込み</strong>も使用できます。（ConsistentRead=true 指定）</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="オペレーション"><a class="header" href="#オペレーション">オペレーション</a></h1>
<p>DynamoDB で使用できる API について紹介します。</p>
<p>詳しくは以下のドキュメントをご覧ください。</p>
<p><a href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Operations.html">Actions - Amazon DynamoDB</a></p>
<h2 id="テーブル関連"><a class="header" href="#テーブル関連">テーブル関連</a></h2>
<ul>
<li>CreateTable
<ul>
<li>新しいテーブルを作成</li>
</ul>
</li>
<li>DescribeTable
<ul>
<li>テーブルに関する情報を取得</li>
</ul>
</li>
<li>ListTables
<ul>
<li>リストのすべてのテーブルの名前を取得</li>
</ul>
</li>
<li>UpdateTable
<ul>
<li>テーブルのインデックス設定を変更</li>
</ul>
</li>
<li>DeleteTable
<ul>
<li>テーブルを削除</li>
</ul>
</li>
</ul>
<h2 id="データ取得"><a class="header" href="#データ取得">データ取得</a></h2>
<ul>
<li>GetItem
<ul>
<li>テーブルから単一の項目を取得</li>
<li><strong>プライマリキーを指定</strong>する</li>
</ul>
</li>
<li>BatchGetItem
<ul>
<li>1度の呼び出しで GetItem を複数回リクエストできる</li>
<li>最大100項目まで取得可能</li>
</ul>
</li>
<li>Query
<ul>
<li><strong>パーティションキーを指定</strong>して項目を取得</li>
<li>複数取得できる</li>
</ul>
</li>
<li>Scan
<ul>
<li>指定テーブル/インデックスのすべての項目を取得</li>
<li>遅い</li>
<li>filter, limit 指定可能だが注意が必要</li>
</ul>
</li>
</ul>
<h2 id="データ作成"><a class="header" href="#データ作成">データ作成</a></h2>
<ul>
<li>PutItem
<ul>
<li>項目の属性を追加</li>
<li><strong>プライマリキーを指定</strong>する</li>
<li>プライマリキー以外の属性は<strong>任意</strong></li>
</ul>
</li>
</ul>
<h2 id="データ更新"><a class="header" href="#データ更新">データ更新</a></h2>
<ul>
<li>UpdateItem
<ul>
<li>項目の属性を更新</li>
<li><strong>プライマリキーを指定</strong>する</li>
</ul>
</li>
</ul>
<h2 id="データ削除"><a class="header" href="#データ削除">データ削除</a></h2>
<ul>
<li>DeleteItem
<ul>
<li>単一の項目を削除</li>
<li><strong>プライマリキーを指定</strong>する</li>
</ul>
</li>
</ul>
<h2 id="その他"><a class="header" href="#その他">その他</a></h2>
<ul>
<li>BatchWriteItem
<ul>
<li>1度の呼び出しで複数の書き込み・削除ができる</li>
<li>大量データの扱いに便利</li>
<li>最大25リクエストまで</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="ハンズオン"><a class="header" href="#ハンズオン">ハンズオン</a></h1>
<p>ここからはローカル環境でDocker, JavaScript SDK を使用して DynamoDB を触っていきます。</p>
<h2 id="起動方法"><a class="header" href="#起動方法">起動方法</a></h2>
<pre><code class="language-bash">git clone git@github.com:nagaokayuji/workshop-dynamodb.git
</code></pre>
<p>プロジェクト配下に移動し、以下を実行します。</p>
<pre><code class="language-bash">docker-compose -f code/docker-compose.yml up
</code></pre>
<ul>
<li><a href="http://localhost:8000/shell/">http://localhost:8000/shell/</a> にアクセス
<ul>
<li><code>DynamoDB JavaScript Shell</code> というタイトルの画面が出れば準備完了</li>
</ul>
</li>
</ul>
<h2 id="gui-アプリケーションの紹介"><a class="header" href="#gui-アプリケーションの紹介">GUI アプリケーションの紹介</a></h2>
<p>今回のハンズオンではインストールしなくても問題ありませんが、
DynamoDB 用のクライアントで NoSQL Workbench というものがあります。</p>
<p>以下のようにテーブルの項目を閲覧したり、インタラクティブにオペレーションを実行することができます。
<img src="https://res.cloudinary.com/ddaz9etkx/image/upload/v1629657624/202108/ss_cgqn0l.png" alt="image" /></p>
<p><a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/workbench.settingup.html">NoSQL Workbench のダウンロード - Amazon DynamoDB</a></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="テーブル一覧を取得listtables"><a class="header" href="#テーブル一覧を取得listtables">テーブル一覧を取得(ListTables)</a></h1>
<p>ListTables を実行してみます。</p>
<p>特にパラメータは必要ありません。</p>
<pre><code class="language-jsx">var params = {
// 今回は指定なし
};
dynamodb.listTables(params, function(err, data) {
    if (err) ppJson(err); // an error occurred
    else ppJson(data); // successful response
});
</code></pre>
<h2 id="実行結果"><a class="header" href="#実行結果">実行結果</a></h2>
<p>実行してみると、</p>
<p>次のようなレスポンスが返ってきます。</p>
<pre><code class="language-jsx">{&quot;TableNames&quot;:[&quot;athlete&quot;]}
</code></pre>
<p><code>athlete</code> というテーブルが存在することがわかりました。</p>
<p>このテーブルには以下のサイトからダウンロードしたCSV(<code>athlete_events.csv</code>)から1000行を抽出したデータが格納されています。</p>
<p><a href="https://www.kaggle.com/mysarahmadbhat/120-years-of-olympic-history">120 Years of Olympic History</a></p>
<pre><code>About this file
ID Unique number for each athlete
Name Athlete's name
Sex Male (M) or Female (F)
Age Integer
Height In centimeters
Weight In kilograms
Team Team name
NOC National Olympic Committee 3-letter code
Games Year and season
Year Integer
Season summer or Winter
City Host city
Sport Sport
Event Event
Medal Gold, Silver, Bronze, or NA
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="テーブルの詳細を取得describetable"><a class="header" href="#テーブルの詳細を取得describetable">テーブルの詳細を取得(DescribeTable)</a></h1>
<p><a href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_DescribeTable.html">DescribeTable - Amazon DynamoDB</a></p>
<p><code>DescribeTable</code> を実行して<code>athlete</code>テーブルの詳細を取得してみましょう。</p>
<p>以下のようにテーブル名(<code>TableName</code>)を指定してDescribeTableを実行します。</p>
<pre><code class="language-jsx">var params = {
    TableName: 'athlete',
};
dynamodb.describeTable(params, function(err, data) {
    if (err) ppJson(err); // an error occurred
    else ppJson(data); // successful response
});
</code></pre>
<h2 id="実行結果-1"><a class="header" href="#実行結果-1">実行結果</a></h2>
<p>実行すると以下のようなレスポンスが返ってきます。</p>
<pre><code class="language-JSON">{
  &quot;Table&quot;: {
    &quot;AttributeDefinitions&quot;: [
      { &quot;AttributeName&quot;: &quot;ID&quot;, &quot;AttributeType&quot;: &quot;N&quot; },
      { &quot;AttributeName&quot;: &quot;index&quot;, &quot;AttributeType&quot;: &quot;N&quot; }
    ],
    &quot;TableName&quot;: &quot;athlete&quot;,
    &quot;KeySchema&quot;: [
      { &quot;AttributeName&quot;: &quot;ID&quot;, &quot;KeyType&quot;: &quot;HASH&quot; },
      { &quot;AttributeName&quot;: &quot;index&quot;, &quot;KeyType&quot;: &quot;RANGE&quot; }
    ],
    &quot;TableStatus&quot;: &quot;ACTIVE&quot;,
    &quot;CreationDateTime&quot;: &quot;2021-08-09T04:33:11.161Z&quot;,
    &quot;ProvisionedThroughput&quot;: {
      &quot;LastIncreaseDateTime&quot;: &quot;1970-01-01T00:00:00.000Z&quot;,
      &quot;LastDecreaseDateTime&quot;: &quot;1970-01-01T00:00:00.000Z&quot;,
      &quot;NumberOfDecreasesToday&quot;: 0,
      &quot;ReadCapacityUnits&quot;: 1,
      &quot;WriteCapacityUnits&quot;: 1
    },
    &quot;TableSizeBytes&quot;: 182074,
    &quot;ItemCount&quot;: 999,
    &quot;TableArn&quot;: &quot;arn:aws:dynamodb:ddblocal:000000000000:table/athlete&quot;
  }
}
</code></pre>
<h2 id="レスポンスの中身について"><a class="header" href="#レスポンスの中身について">レスポンスの中身について</a></h2>
<p>TableDescription の定義が返ってきます。</p>
<p>詳しくは以下に記載があります。</p>
<p><a href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_TableDescription.html">TableDescription - Amazon DynamoDB</a></p>
<h3 id="attributedefinitions"><a class="header" href="#attributedefinitions">AttributeDefinitions</a></h3>
<ul>
<li>AttributeName
<ul>
<li>属性名です。</li>
</ul>
</li>
<li>AttributeType
<ul>
<li>属性のデータ型の定義です。
<ul>
<li>N = Number</li>
<li>S = String</li>
<li>B = Binary</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>※ DynamoDB の型について</p>
<p><a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/DynamoDBMapper.DataTypes.html">サポートされているデータの種類</a></p>
<h3 id="keyschema"><a class="header" href="#keyschema">KeySchema</a></h3>
<p>パーティションキー・ソートキー情報です。</p>
<ul>
<li>AttributeName
<ul>
<li>属性名です。</li>
</ul>
</li>
<li>KeyType
<ul>
<li>その名の通りキーのタイプです。</li>
<li><code>HASH</code>　= パーティションキー</li>
<li><code>RANGE</code> = ソートキー</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="テーブルのデータを取得scan"><a class="header" href="#テーブルのデータを取得scan">テーブルのデータを取得(Scan)</a></h1>
<p>Scanでは簡単にテーブルの内容を（複数件）取得することができます。</p>
<p>後述する Query と比べると大量の RCU を消費するため注意が必要です。</p>
<p>様々なオプションが指定できますが、今回は<code>Limit</code> を指定し、3件取得してみます。</p>
<pre><code class="language-jsx">var params = {
    TableName: 'athlete',
    Limit: 3, // 3件取得
    ReturnConsumedCapacity: 'TOTAL', // 消費したキャパシティユニットも返す
};
dynamodb.scan(params, function(err, data) {
    if (err) ppJson(err); // an error occurred
    else ppJson(data); // successful response
});
</code></pre>
<h2 id="実行結果-2"><a class="header" href="#実行結果-2">実行結果</a></h2>
<p>これを実行すると
以下のような結果が得られると思います。</p>
<pre><code class="language-json">{
  &quot;Items&quot;: [
    {
      &quot;NOC&quot;: { &quot;S&quot;: &quot;NOR&quot; },
      &quot;Sex&quot;: { &quot;S&quot;: &quot;M&quot; },
      &quot;index&quot;: { &quot;N&quot;: &quot;118&quot; },
      &quot;City&quot;: { &quot;S&quot;: &quot;Barcelona&quot; },
      &quot;Weight&quot;: { &quot;N&quot;: &quot;75&quot; },
      &quot;Name&quot;: { &quot;S&quot;: &quot;Morten Gjerdrum Aasen&quot; },
      &quot;Sport&quot;: { &quot;S&quot;: &quot;Equestrianism&quot; },
      &quot;Year&quot;: { &quot;N&quot;: &quot;1992&quot; },
      &quot;Games&quot;: { &quot;S&quot;: &quot;1992 Summer&quot; },
      &quot;Event&quot;: { &quot;S&quot;: &quot;Equestrianism Mixed Jumping, Individual&quot; },
      &quot;Height&quot;: { &quot;N&quot;: &quot;185&quot; },
      &quot;Team&quot;: { &quot;S&quot;: &quot;Norway&quot; },
      &quot;ID&quot;: { &quot;N&quot;: &quot;43&quot; },
      &quot;Medal&quot;: { &quot;NULL&quot;: true },
      &quot;Season&quot;: { &quot;S&quot;: &quot;Summer&quot; },
      &quot;Age&quot;: { &quot;N&quot;: &quot;34&quot; }
    },
    {
      &quot;NOC&quot;: { &quot;S&quot;: &quot;UZB&quot; },
      &quot;Sex&quot;: { &quot;S&quot;: &quot;M&quot; },
      &quot;index&quot;: { &quot;N&quot;: &quot;610&quot; },
      &quot;City&quot;: { &quot;S&quot;: &quot;Athina&quot; },
      &quot;Weight&quot;: { &quot;N&quot;: &quot;73&quot; },
      &quot;Name&quot;: { &quot;S&quot;: &quot;Sherzod Abdurahmonov&quot; },
      &quot;Sport&quot;: { &quot;S&quot;: &quot;Boxing&quot; },
      &quot;Year&quot;: { &quot;N&quot;: &quot;2004&quot; },
      &quot;Games&quot;: { &quot;S&quot;: &quot;2004 Summer&quot; },
      &quot;Event&quot;: { &quot;S&quot;: &quot;Boxing Men's Middleweight&quot; },
      &quot;Height&quot;: { &quot;N&quot;: &quot;178&quot; },
      &quot;Team&quot;: { &quot;S&quot;: &quot;Uzbekistan&quot; },
      &quot;ID&quot;: { &quot;N&quot;: &quot;352&quot; },
      &quot;Medal&quot;: { &quot;NULL&quot;: true },
      &quot;Season&quot;: { &quot;S&quot;: &quot;Summer&quot; },
      &quot;Age&quot;: { &quot;N&quot;: &quot;22&quot; }
    },
    {
      &quot;NOC&quot;: { &quot;S&quot;: &quot;CRC&quot; },
      &quot;Sex&quot;: { &quot;S&quot;: &quot;M&quot; },
      &quot;index&quot;: { &quot;N&quot;: &quot;907&quot; },
      &quot;City&quot;: { &quot;S&quot;: &quot;Los Angeles&quot; },
      &quot;Weight&quot;: { &quot;N&quot;: &quot;72&quot; },
      &quot;Name&quot;: { &quot;S&quot;: &quot;Glen Abrahams Martnez&quot; },
      &quot;Sport&quot;: { &quot;S&quot;: &quot;Athletics&quot; },
      &quot;Year&quot;: { &quot;N&quot;: &quot;1984&quot; },
      &quot;Games&quot;: { &quot;S&quot;: &quot;1984 Summer&quot; },
      &quot;Event&quot;: { &quot;S&quot;: &quot;Athletics Men's 100 metres&quot; },
      &quot;Height&quot;: { &quot;N&quot;: &quot;179&quot; },
      &quot;Team&quot;: { &quot;S&quot;: &quot;Costa Rica&quot; },
      &quot;ID&quot;: { &quot;N&quot;: &quot;517&quot; },
      &quot;Medal&quot;: { &quot;NULL&quot;: true },
      &quot;Season&quot;: { &quot;S&quot;: &quot;Summer&quot; },
      &quot;Age&quot;: { &quot;N&quot;: &quot;22&quot; }
    }
  ],
  &quot;Count&quot;: 3,
  &quot;ScannedCount&quot;: 3,
  &quot;LastEvaluatedKey&quot;: { &quot;index&quot;: { &quot;N&quot;: &quot;907&quot; }, &quot;ID&quot;: { &quot;N&quot;: &quot;517&quot; } },
  &quot;ConsumedCapacity&quot;: { &quot;TableName&quot;: &quot;athlete&quot;, &quot;CapacityUnits&quot;: 0.5 }
}
</code></pre>
<h3 id="結果の見方"><a class="header" href="#結果の見方">結果の見方</a></h3>
<ul>
<li>Items
<ul>
<li>ここに取得したデータが入っています。</li>
</ul>
</li>
<li>Count
<ul>
<li>結果の件数です。</li>
</ul>
</li>
<li>ScannedCount
<ul>
<li>スキャンされた件数です。</li>
<li>FilterExpression 等で絞り込まれる前の件数を指します。</li>
</ul>
</li>
<li>LastEvaluatedKey
<ul>
<li>オペレーションが終了したときのプライマリキーです。</li>
<li>すべての要素がScanされた場合は空になります。</li>
</ul>
</li>
</ul>
<h2 id="scanのオプション"><a class="header" href="#scanのオプション">Scanのオプション</a></h2>
<p>いくつか紹介します。</p>
<ul>
<li>FilterExpression
<ul>
<li>結果を絞り込むことができます。</li>
<li>表示される結果を絞り込むため、指定しても消費する RCU は変わりません。</li>
</ul>
</li>
<li>IndexName
<ul>
<li>セカンダリインデックスを使用する場合に指定します。</li>
</ul>
</li>
<li>Select
<ul>
<li>結果の属性を指定できます。</li>
<li>指定できる内容は以下です。
<ul>
<li>ALL_ATTRIBUTES
<ul>
<li>すべての属性を返します。</li>
<li>何も指定しない場合はこれが指定されます。</li>
</ul>
</li>
<li>ALL_PROJECTED_ATTRIBUTES
<ul>
<li>インデックスで設定されたすべての属性を返します。</li>
<li>インデックス使用の場合に指定できます。</li>
</ul>
</li>
<li>SPECIFIC_ATTRIBUTES
<ul>
<li><code>AttributesToGet</code> に指定した属性のみを返します。</li>
</ul>
</li>
<li>COUNT
<ul>
<li>マッチした件数のみを返します。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="テーブルのデータを取得query"><a class="header" href="#テーブルのデータを取得query">テーブルのデータを取得(Query)</a></h1>
<p><a href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Query.html">Query - Amazon DynamoDB</a></p>
<p><code>Query</code> ではパーティションキーを指定し、パーティションキーが一致したすべての項目を取得します。</p>
<p><code>KeyConditionExpression</code> を指定してパーティションキーを指定する必要があります。</p>
<p>※ 同様にソートキーの条件も指定することができます。</p>
<p>ここでは、 <code>ID</code> が <code>5</code> のデータを取得してみます。</p>
<pre><code class="language-jsx">var params = {
    TableName: 'athlete',
    KeyConditionExpression: 'ID = :val', // :val のようなプレースホルダが必要
    ExpressionAttributeValues: { 
        &quot;:val&quot;: 5, // :val の値
    }, 
    ScanIndexForward: true, // ソートキーの昇順
};
docClient.query(params, function(err, data) {
    if (err) ppJson(err); // an error occurred
    else ppJson(data); // successful response
});
</code></pre>
<h2 id="実行結果-3"><a class="header" href="#実行結果-3">実行結果</a></h2>
<p>結果は以下のようになります。</p>
<pre><code class="language-json">{
  &quot;Items&quot;: [
    {
      &quot;NOC&quot;: &quot;NED&quot;,
      &quot;Sex&quot;: &quot;F&quot;,
      &quot;index&quot;: 4,
      &quot;City&quot;: &quot;Calgary&quot;,
      &quot;Weight&quot;: 82,
      &quot;Name&quot;: &quot;Christine Jacoba Aaftink&quot;,
      &quot;Sport&quot;: &quot;Speed Skating&quot;,
      &quot;Year&quot;: 1988,
      &quot;Games&quot;: &quot;1988 Winter&quot;,
      &quot;Event&quot;: &quot;Speed Skating Women's 500 metres&quot;,
      &quot;Height&quot;: 185,
      &quot;Team&quot;: &quot;Netherlands&quot;,
      &quot;ID&quot;: 5,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 21
    },
    {
      &quot;NOC&quot;: &quot;NED&quot;,
      &quot;Sex&quot;: &quot;F&quot;,
      &quot;index&quot;: 5,
      &quot;City&quot;: &quot;Calgary&quot;,
      &quot;Weight&quot;: 82,
      &quot;Name&quot;: &quot;Christine Jacoba Aaftink&quot;,
      &quot;Sport&quot;: &quot;Speed Skating&quot;,
      &quot;Year&quot;: 1988,
      &quot;Games&quot;: &quot;1988 Winter&quot;,
      &quot;Event&quot;: &quot;Speed Skating Women's 1,000 metres&quot;,
      &quot;Height&quot;: 185,
      &quot;Team&quot;: &quot;Netherlands&quot;,
      &quot;ID&quot;: 5,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 21
    },
    {
      &quot;NOC&quot;: &quot;NED&quot;,
      &quot;Sex&quot;: &quot;F&quot;,
      &quot;index&quot;: 6,
      &quot;City&quot;: &quot;Albertville&quot;,
      &quot;Weight&quot;: 82,
      &quot;Name&quot;: &quot;Christine Jacoba Aaftink&quot;,
      &quot;Sport&quot;: &quot;Speed Skating&quot;,
      &quot;Year&quot;: 1992,
      &quot;Games&quot;: &quot;1992 Winter&quot;,
      &quot;Event&quot;: &quot;Speed Skating Women's 500 metres&quot;,
      &quot;Height&quot;: 185,
      &quot;Team&quot;: &quot;Netherlands&quot;,
      &quot;ID&quot;: 5,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 25
    },
    {
      &quot;NOC&quot;: &quot;NED&quot;,
      &quot;Sex&quot;: &quot;F&quot;,
      &quot;index&quot;: 7,
      &quot;City&quot;: &quot;Albertville&quot;,
      &quot;Weight&quot;: 82,
      &quot;Name&quot;: &quot;Christine Jacoba Aaftink&quot;,
      &quot;Sport&quot;: &quot;Speed Skating&quot;,
      &quot;Year&quot;: 1992,
      &quot;Games&quot;: &quot;1992 Winter&quot;,
      &quot;Event&quot;: &quot;Speed Skating Women's 1,000 metres&quot;,
      &quot;Height&quot;: 185,
      &quot;Team&quot;: &quot;Netherlands&quot;,
      &quot;ID&quot;: 5,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 25
    },
    {
      &quot;NOC&quot;: &quot;NED&quot;,
      &quot;Sex&quot;: &quot;F&quot;,
      &quot;index&quot;: 8,
      &quot;City&quot;: &quot;Lillehammer&quot;,
      &quot;Weight&quot;: 82,
      &quot;Name&quot;: &quot;Christine Jacoba Aaftink&quot;,
      &quot;Sport&quot;: &quot;Speed Skating&quot;,
      &quot;Year&quot;: 1994,
      &quot;Games&quot;: &quot;1994 Winter&quot;,
      &quot;Event&quot;: &quot;Speed Skating Women's 500 metres&quot;,
      &quot;Height&quot;: 185,
      &quot;Team&quot;: &quot;Netherlands&quot;,
      &quot;ID&quot;: 5,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 27
    },
    {
      &quot;NOC&quot;: &quot;NED&quot;,
      &quot;Sex&quot;: &quot;F&quot;,
      &quot;index&quot;: 9,
      &quot;City&quot;: &quot;Lillehammer&quot;,
      &quot;Weight&quot;: 82,
      &quot;Name&quot;: &quot;Christine Jacoba Aaftink&quot;,
      &quot;Sport&quot;: &quot;Speed Skating&quot;,
      &quot;Year&quot;: 1994,
      &quot;Games&quot;: &quot;1994 Winter&quot;,
      &quot;Event&quot;: &quot;Speed Skating Women's 1,000 metres&quot;,
      &quot;Height&quot;: 185,
      &quot;Team&quot;: &quot;Netherlands&quot;,
      &quot;ID&quot;: 5,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 27
    }
  ],
  &quot;Count&quot;: 6,
  &quot;ScannedCount&quot;: 6
}
</code></pre>
<p>結果の項目は Scan と同様になっています。</p>
<h2 id="注意"><a class="header" href="#注意">注意</a></h2>
<p><code>athlete</code> テーブルでは <code>ID</code> がパーティションキーであることに注意してください。</p>
<p>例えば、以下のようにパーティションキーを指定しないクエリはエラーとなります。</p>
<pre><code class="language-jsx">var params = {
    TableName: 'athlete',
    KeyConditionExpression: 'Year = :val',
    ExpressionAttributeValues: { 
        &quot;:Year&quot;: 1994, 
    }, 
    ScanIndexForward: true, 
};
docClient.query(params, function(err, data) {
    if (err) ppJson(err); // an error occurred
    else ppJson(data); // successful response
});
</code></pre>
<h2 id="query-のオプション"><a class="header" href="#query-のオプション">Query のオプション</a></h2>
<p>いくつか紹介します。</p>
<ul>
<li>KeyConditionExpression
<ul>
<li>Query 特有のオプションです。</li>
<li>パーティションキーやソートキーの条件を指定します。</li>
<li>パーティションキー
<ul>
<li><code>partitionKeyName = :partitionkeyval</code> の形式にする必要があります。</li>
</ul>
</li>
<li>ソートキー
<ul>
<li><code>=</code> 以外の演算子も使用できます。
<ul>
<li><code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>BETWEEN</code>, <code>begins_with</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ExpressionAttributeNames
<ul>
<li>expressionで使用される属性名に名前を設定します。</li>
<li>名前には<code>#</code>で始まる文字を指定します。</li>
<li>ユースケースには以下があります。
<ul>
<li>DynamoDB の予約語と競合する場合</li>
<li>繰り返し使用される値にプレースホルダを設定したい場合</li>
<li>属性名の特殊文字のエスケープ</li>
</ul>
</li>
</ul>
</li>
<li>ExpressionAttributeValues
<ul>
<li>expression で使用される値に名前を設定します。</li>
<li>名前には<code>:</code>で始まる文字を指定します。</li>
</ul>
</li>
<li>ScanIndexForward
<ul>
<li>ソートキーの順序を指定できます。</li>
<li>true
<ul>
<li>昇順になります。</li>
<li>指定しない場合はtrueとして扱われます。</li>
</ul>
</li>
<li>false
<ul>
<li>降順になります。</li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="gsiを追加する"><a class="header" href="#gsiを追加する">GSIを追加する</a></h1>
<p>GSI を追加するには
<code>UpdateTable</code> オペレーションで <code>GlobalSecondaryIndexUpdates</code>を指定します。</p>
<p>ここでは <code>Year</code> をパーティションキーとしたGSIを追加してみます。</p>
<pre><code class="language-jsx">var params = {
  TableName: &quot;athlete&quot;,
  AttributeDefinitions: [
    { AttributeName: &quot;Year&quot;, AttributeType: &quot;N&quot; },
    { AttributeName: &quot;ID&quot;, AttributeType: &quot;N&quot; },
  ],
  GlobalSecondaryIndexUpdates: [
    {
      // GSIを更新
      Create: {
        // 追加
        IndexName: &quot;byYear&quot;, // 名前をつける
        KeySchema: [
          {
            AttributeName: &quot;Year&quot;, // Year をパーティションキーに設定
            KeyType: &quot;HASH&quot;,
          },
          {
            AttributeName: &quot;ID&quot;, // ID をソートキーに設定
            KeyType: &quot;RANGE&quot;,
          },
        ],
        Projection: {
          ProjectionType: &quot;ALL&quot;, // すべての属性に対して適用
        },
        ProvisionedThroughput: {
          ReadCapacityUnits: 1,
          WriteCapacityUnits: 1,
        },
      },
    },
  ],
};
dynamodb.updateTable(params, function (err, data) {
  if (err) ppJson(err);
  // an error occurred
  else ppJson(data); // successful response
});
</code></pre>
<h2 id="実行結果-4"><a class="header" href="#実行結果-4">実行結果</a></h2>
<p><code>byYear</code> という名前でGSIを作成しました。</p>
<p>実行すると以下のようなレスポンスが得られます。</p>
<p>なお、下記のレスポンスは DescribeTable を実行すると同様の結果となります。</p>
<pre><code class="language-json">{
  &quot;TableDescription&quot;: {
    &quot;AttributeDefinitions&quot;: [
      { &quot;AttributeName&quot;: &quot;Year&quot;, &quot;AttributeType&quot;: &quot;N&quot; },
      { &quot;AttributeName&quot;: &quot;index&quot;, &quot;AttributeType&quot;: &quot;N&quot; },
      { &quot;AttributeName&quot;: &quot;ID&quot;, &quot;AttributeType&quot;: &quot;N&quot; }
    ],
    &quot;TableName&quot;: &quot;athlete&quot;,
    &quot;KeySchema&quot;: [
      { &quot;AttributeName&quot;: &quot;ID&quot;, &quot;KeyType&quot;: &quot;HASH&quot; },
      { &quot;AttributeName&quot;: &quot;index&quot;, &quot;KeyType&quot;: &quot;RANGE&quot; }
    ],
    &quot;TableStatus&quot;: &quot;ACTIVE&quot;,
    &quot;CreationDateTime&quot;: &quot;2021-08-09T04:33:11.161Z&quot;,
    &quot;ProvisionedThroughput&quot;: {
      &quot;LastIncreaseDateTime&quot;: &quot;1970-01-01T00:00:00.000Z&quot;,
      &quot;LastDecreaseDateTime&quot;: &quot;1970-01-01T00:00:00.000Z&quot;,
      &quot;NumberOfDecreasesToday&quot;: 0,
      &quot;ReadCapacityUnits&quot;: 1,
      &quot;WriteCapacityUnits&quot;: 1
    },
    &quot;TableSizeBytes&quot;: 182074,
    &quot;ItemCount&quot;: 999,
    &quot;TableArn&quot;: &quot;arn:aws:dynamodb:ddblocal:000000000000:table/athlete&quot;,
    &quot;GlobalSecondaryIndexes&quot;: [
      {
        &quot;IndexName&quot;: &quot;byYear&quot;,
        &quot;KeySchema&quot;: [
          { &quot;AttributeName&quot;: &quot;Year&quot;, &quot;KeyType&quot;: &quot;HASH&quot; },
          { &quot;AttributeName&quot;: &quot;ID&quot;, &quot;KeyType&quot;: &quot;RANGE&quot; }
        ],
        &quot;Projection&quot;: { &quot;ProjectionType&quot;: &quot;ALL&quot; },
        &quot;IndexStatus&quot;: &quot;CREATING&quot;,
        &quot;Backfilling&quot;: false,
        &quot;ProvisionedThroughput&quot;: {
          &quot;ReadCapacityUnits&quot;: 1,
          &quot;WriteCapacityUnits&quot;: 1
        },
        &quot;IndexArn&quot;: &quot;arn:aws:dynamodb:ddblocal:000000000000:table/athlete/index/byYear&quot;
      }
    ]
  }
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="gsiを使用してqueryを実行する"><a class="header" href="#gsiを使用してqueryを実行する">GSIを使用してQueryを実行する</a></h1>
<p>追加したGSIを使用してQueryを発行してみましょう。</p>
<p>以下のように <code>IndexName</code> を指定し、特定の <code>Year</code> を持つ項目を取得できます。</p>
<p>ここでは<code>Year</code>が<code>1994</code>の項目を取得してみます。</p>
<pre><code class="language-jsx">var params = {
  TableName: &quot;athlete&quot;,
  IndexName: &quot;byYear&quot;, // 先ほど追加した GSI
  KeyConditionExpression: &quot;#y = :year&quot;, // Year は予約語のため、 #y に置き換える
  ExpressionAttributeNames: {
    &quot;#y&quot;: &quot;Year&quot;, // #y を Year にマッピング
  },
  ExpressionAttributeValues: {
    &quot;:year&quot;: 1994,
  },
  Limit: 5, // 5件
  ScanIndexForward: true, // ID の昇順に取得
  ReturnConsumedCapacity: &quot;INDEXES&quot;, // セカンダリインデックスの小計も取得
};
docClient.query(params, function (err, data) {
  if (err) ppJson(err);
  // an error occurred
  else ppJson(data); // successful response
});
</code></pre>
<p>ここで、<code>ReturnConsumedCapacity: &quot;INDEXES&quot;</code> を指定することでセカンダリインデックスのアクセスも表示することができます。</p>
<h2 id="実行結果-5"><a class="header" href="#実行結果-5">実行結果</a></h2>
<p>結果が5件返ってきていることを確認しておきましょう。</p>
<pre><code class="language-json">{
  &quot;Items&quot;: [
    {
      &quot;NOC&quot;: &quot;NED&quot;,
      &quot;Sex&quot;: &quot;F&quot;,
      &quot;index&quot;: 9,
      &quot;City&quot;: &quot;Lillehammer&quot;,
      &quot;Weight&quot;: 82,
      &quot;Name&quot;: &quot;Christine Jacoba Aaftink&quot;,
      &quot;Sport&quot;: &quot;Speed Skating&quot;,
      &quot;Year&quot;: 1994,
      &quot;Games&quot;: &quot;1994 Winter&quot;,
      &quot;Event&quot;: &quot;Speed Skating Women's 1,000 metres&quot;,
      &quot;Height&quot;: 185,
      &quot;Team&quot;: &quot;Netherlands&quot;,
      &quot;ID&quot;: 5,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 27
    },
    {
      &quot;NOC&quot;: &quot;NED&quot;,
      &quot;Sex&quot;: &quot;F&quot;,
      &quot;index&quot;: 8,
      &quot;City&quot;: &quot;Lillehammer&quot;,
      &quot;Weight&quot;: 82,
      &quot;Name&quot;: &quot;Christine Jacoba Aaftink&quot;,
      &quot;Sport&quot;: &quot;Speed Skating&quot;,
      &quot;Year&quot;: 1994,
      &quot;Games&quot;: &quot;1994 Winter&quot;,
      &quot;Event&quot;: &quot;Speed Skating Women's 500 metres&quot;,
      &quot;Height&quot;: 185,
      &quot;Team&quot;: &quot;Netherlands&quot;,
      &quot;ID&quot;: 5,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 27
    },
    {
      &quot;NOC&quot;: &quot;USA&quot;,
      &quot;Sex&quot;: &quot;M&quot;,
      &quot;index&quot;: 15,
      &quot;City&quot;: &quot;Lillehammer&quot;,
      &quot;Weight&quot;: 75,
      &quot;Name&quot;: &quot;Per Knut Aaland&quot;,
      &quot;Sport&quot;: &quot;Cross Country Skiing&quot;,
      &quot;Year&quot;: 1994,
      &quot;Games&quot;: &quot;1994 Winter&quot;,
      &quot;Event&quot;: &quot;Cross Country Skiing Men's 30 kilometres&quot;,
      &quot;Height&quot;: 188,
      &quot;Team&quot;: &quot;United States&quot;,
      &quot;ID&quot;: 6,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 33
    },
    {
      &quot;NOC&quot;: &quot;USA&quot;,
      &quot;Sex&quot;: &quot;M&quot;,
      &quot;index&quot;: 14,
      &quot;City&quot;: &quot;Lillehammer&quot;,
      &quot;Weight&quot;: 75,
      &quot;Name&quot;: &quot;Per Knut Aaland&quot;,
      &quot;Sport&quot;: &quot;Cross Country Skiing&quot;,
      &quot;Year&quot;: 1994,
      &quot;Games&quot;: &quot;1994 Winter&quot;,
      &quot;Event&quot;: &quot;Cross Country Skiing Men's 10 kilometres&quot;,
      &quot;Height&quot;: 188,
      &quot;Team&quot;: &quot;United States&quot;,
      &quot;ID&quot;: 6,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 33
    },
    {
      &quot;NOC&quot;: &quot;USA&quot;,
      &quot;Sex&quot;: &quot;M&quot;,
      &quot;index&quot;: 17,
      &quot;City&quot;: &quot;Lillehammer&quot;,
      &quot;Weight&quot;: 75,
      &quot;Name&quot;: &quot;Per Knut Aaland&quot;,
      &quot;Sport&quot;: &quot;Cross Country Skiing&quot;,
      &quot;Year&quot;: 1994,
      &quot;Games&quot;: &quot;1994 Winter&quot;,
      &quot;Event&quot;: &quot;Cross Country Skiing Men's 4 x 10 kilometres Relay&quot;,
      &quot;Height&quot;: 188,
      &quot;Team&quot;: &quot;United States&quot;,
      &quot;ID&quot;: 6,
      &quot;Medal&quot;: null,
      &quot;Season&quot;: &quot;Winter&quot;,
      &quot;Age&quot;: 33
    }
  ],
  &quot;Count&quot;: 5,
  &quot;ScannedCount&quot;: 5,
  &quot;LastEvaluatedKey&quot;: { &quot;Year&quot;: 1994, &quot;index&quot;: 17, &quot;ID&quot;: 6 },
  &quot;ConsumedCapacity&quot;: {
    &quot;TableName&quot;: &quot;athlete&quot;,
    &quot;CapacityUnits&quot;: 0.5,
    &quot;Table&quot;: { &quot;CapacityUnits&quot;: 0 },
    &quot;GlobalSecondaryIndexes&quot;: { &quot;byYear&quot;: { &quot;CapacityUnits&quot;: 0.5 } }
  }
}
</code></pre>
<p>以上より、GSIを使用してQueryを発行することができました。</p>
<h3 id="consumedcapacity-を見てみる"><a class="header" href="#consumedcapacity-を見てみる">ConsumedCapacity を見てみる</a></h3>
<pre><code class="language-json">&quot;GlobalSecondaryIndexes&quot;: { &quot;byYear&quot;: { &quot;CapacityUnits&quot;: 0.5 } }
</code></pre>
<p>追加したGSIが使用されていることがわかります。</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="scan-filter-の注意点"><a class="header" href="#scan-filter-の注意点">Scan, Filter の注意点</a></h1>
<p>前項ではGSIを追加して特定の<code>Year</code>で検索しましたが、以下のような疑問が湧くのではないでしょうか。</p>
<ul>
<li>Scan で filter を使えばよいのでは？</li>
</ul>
<p>以下のようなScanオペレーションで試してみましょう。</p>
<p><code>FilterExpression</code> に 前項の<code>KeyConditionExpression</code> と同一の条件を指定しています。</p>
<pre><code class="language-jsx">var params = {
  TableName: &quot;athlete&quot;,
  Limit: 5, // 5 件取得したい
  FilterExpression: &quot;#y = :year&quot;,
  ExpressionAttributeNames: {
    &quot;#y&quot;: &quot;Year&quot;,
  },
  ExpressionAttributeValues: {
    &quot;:year&quot;: { N: &quot;1994&quot; },
  },
  ReturnConsumedCapacity: &quot;INDEXES&quot;,
};
dynamodb.scan(params, function (err, data) {
  if (err) ppJson(err);
  // an error occurred
  else ppJson(data); // successful response
});
</code></pre>
<h2 id="実行結果-6"><a class="header" href="#実行結果-6">実行結果</a></h2>
<p>以下のような結果が得られました。</p>
<pre><code class="language-json">{
  &quot;Items&quot;: [],
  &quot;Count&quot;: 0,
  &quot;ScannedCount&quot;: 5,
  &quot;LastEvaluatedKey&quot;: { &quot;index&quot;: { &quot;N&quot;: &quot;895&quot; }, &quot;ID&quot;: { &quot;N&quot;: &quot;512&quot; } },
  &quot;ConsumedCapacity&quot;: {
    &quot;TableName&quot;: &quot;athlete&quot;,
    &quot;CapacityUnits&quot;: 0.5,
    &quot;Table&quot;: { &quot;CapacityUnits&quot;: 0.5 }
  }
}
</code></pre>
<p>思った件数の結果が得られません。</p>
<p><strong>FilterExpression はクエリの結果を取得してから</strong>絞り込みを行うため、今回のケースだと<strong>5件分Scanしてから</strong>条件に合致した項目のみを返しています。</p>
<p>このため、結果が失われないようにするためには Limit を指定せずに Scan を実行する必要があり、この場合大量のキャパシティユニットを消費することになります。</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="おわりに"><a class="header" href="#おわりに">おわりに</a></h1>
<h2 id="その他のトピック"><a class="header" href="#その他のトピック">その他のトピック</a></h2>
<p>今回詳しく触れられなかったものとしては次のようなものがあり、ここで軽くご紹介します。</p>
<h3 id="partiql"><a class="header" href="#partiql">PartiQL</a></h3>
<p>DynamoDB で使用できる SQLライクな問合せ言語です。</p>
<p>SQLに慣れている場合は書きやすいという利点がありますが、DynamoDBの特性を理解していないと効率の悪いクエリになってしまう懸念があります。</p>
<h3 id="設計について"><a class="header" href="#設計について">設計について</a></h3>
<p>詳しい設計の注意点やベストプラクティスについてはこちらにまとまっています。</p>
<ul>
<li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/best-practices.html">Best Practices for Designing and Architecting with DynamoDB - Amazon DynamoDB</a></li>
</ul>
<h3 id="dynamodb-streams"><a class="header" href="#dynamodb-streams">DynamoDB Streams</a></h3>
<p>テーブル内のデータ項目に対する変更をイベントとしてキャプチャする機能です。
変更をトリガーとしてリアルタイムな処理が可能になります。</p>
<p>過去24時間以内の変更が保持されます。</p>
<h3 id="ttl"><a class="header" href="#ttl">TTL</a></h3>
<p>設定した期限(TTL)になると自動で項目を削除する機能です。（厳密にはTTLを過ぎてから48時間以内）
期限は <strong>エポック形式</strong> の値にする必要があります。</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="参考"><a class="header" href="#参考">参考</a></h1>
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/APIReference/API_Query.html">Query - Amazon DynamoDB</a></li>
<li><a href="https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/bp-query-scan.html">データのクエリとスキャンのベストプラクティス - Amazon DynamoDB</a></li>
<li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Scan.html">Scan - Amazon DynamoDB</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
